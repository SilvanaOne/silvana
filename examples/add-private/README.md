# Add Private Agent

A CLI tool and agent for the Silvana Private coordination layer. This example demonstrates how to:
- Generate Ed25519 keypairs for authentication
- Create app instances on the Private layer
- Submit jobs via gRPC
- Process jobs as an agent

## Quick Start

### 1. Setup (One-time)

Generate keys and create an app instance:

```bash
make setup
```

This will:
- Generate an Ed25519 keypair
- Create an app instance using the public key as the instance ID
- Display environment variables to add to `.env`

Add the displayed environment variables to your `.env` file:
```bash
SILVANA_PRIVATE_KEY=<hex>
SILVANA_PUBLIC_KEY=<hex>
APP_INSTANCE_ID=<hex_public_key>
```

### 2. Submit a Job

Submit an add job (1+1):

```bash
make add
```

This creates a job in the Private coordination layer that will be processed by agents.

### 3. Run Agent

Process jobs from the coordinator:

```bash
make run
```

The agent will:
- Connect to the Silvana coordinator
- Fetch pending jobs for the configured developer/agent/method
- Process jobs with mock 10-second delays
- Report completion back to the coordinator

## CLI Commands

The agent binary supports three commands:

### `cargo run -- setup`

Generates an Ed25519 keypair, uses the public key as the app instance ID, creates a JWT token, and calls the Private coordination layer's gRPC `CreateAppInstance` endpoint.

**Output:**
- Private key (hex)
- Public key (hex)
- App instance ID (same as public key)
- Success confirmation from gRPC

### `cargo run -- add`

Submits an "add" job to the Private coordination layer via gRPC `SubmitUserAction`.

**Requirements:**
- `.env` must contain `SILVANA_PRIVATE_KEY`, `SILVANA_PUBLIC_KEY`, and `APP_INSTANCE_ID`
- State Service must be running at `STATE_SERVICE_URL`

**Output:**
- Action sequence number

### `cargo run -- agent`

Runs as a Silvana agent, processing jobs from the coordinator.

**Configuration:**
- `config.toml`: Agent configuration (developer, agent, method, coordinator URL)
- Environment variables override config values (Docker pattern)

**Supported job methods:**
- `init`: Initialization (10s mock delay)
- `add`: Addition operation (10s mock delay)
- `settle`: Settlement (10s mock delay)

## Architecture

### Directory Structure

```
examples/add-private/
├── agent/
│   ├── src/
│   │   ├── main.rs      # CLI entry point
│   │   ├── setup.rs     # Setup command
│   │   ├── add.rs       # Add job command
│   │   ├── agent.rs     # Agent command
│   │   └── jwt.rs       # JWT utilities
│   ├── Cargo.toml       # Dependencies
│   ├── config.toml      # Agent configuration
│   └── Dockerfile       # Multi-stage Docker build
├── .env                 # Environment variables
├── Makefile             # Build/run commands
└── README.md            # This file
```

### Authentication

The Private coordination layer uses **Ed25519 JWT authentication**:

1. **Key Generation**: Ed25519 keypair generated using `ed25519_dalek`
2. **App Instance ID**: Hex-encoded public key
3. **JWT Structure**:
   ```json
   {
     "alg": "EdDSA",
     "typ": "JWT"
   }
   {
     "sub": "<public_key_hex>",
     "aud": "private",
     "scope": "app_instance <app_instance_id>",
     "exp": <timestamp>,
     "iat": <timestamp>
   }
   ```
4. **Signing**: JWT signed with Ed25519 private key
5. **Usage**: All gRPC calls include `JWTAuth { token }` field

### gRPC Communication

**State Service** (Private Coordination):
- Endpoint: `STATE_SERVICE_URL` (default: `http://localhost:50052`)
- Proto: `silvana.state.v1.StateService`
- Methods used:
  - `CreateAppInstance`: Create new app instance
  - `SubmitUserAction`: Submit jobs

**Coordinator Service** (Job Assignment):
- Endpoint: `COORDINATOR_URL` (default: `http://host.docker.internal:50051`)
- Proto: `silvana.coordinator.v1.CoordinatorService`
- Methods used:
  - `GetJob`: Fetch next job
  - `CompleteJob`: Mark job as completed
  - `FailJob`: Mark job as failed

## Environment Variables

### Required (generated by setup)
- `SILVANA_PRIVATE_KEY`: Ed25519 private key (hex)
- `SILVANA_PUBLIC_KEY`: Ed25519 public key (hex)
- `APP_INSTANCE_ID`: App instance identifier (same as public key)

### Optional (with defaults)
- `STATE_SERVICE_URL`: Private coordination gRPC endpoint (default: `http://localhost:50052`)
- `SILVANA_AUD`: JWT audience (default: `private`)
- `COORDINATOR_URL`: Coordinator gRPC endpoint (default: `http://host.docker.internal:50051`)
- `DEVELOPER_NAME`: Developer identifier (default: `AddPrivateDeveloper`)
- `AGENT_NAME`: Agent identifier (default: `AddPrivateAgent`)
- `APP_NAME`: Application name (default: `add_private_app`)

## Docker

### Build Docker Image

```bash
make build
```

Set `DOCKER_IMAGE` in `.env` first:
```bash
DOCKER_IMAGE=docker.io/your_username/add-private-agent:latest
```

### Push to Registry

```bash
make push
```

### Run in Docker

```bash
docker run --rm \
  -e COORDINATOR_URL=http://host.docker.internal:50051 \
  -e SESSION_ID=<session_id> \
  -e DEVELOPER=AddPrivateDeveloper \
  -e AGENT=AddPrivateAgent \
  -e AGENT_METHOD=prove \
  $DOCKER_IMAGE
```

## Development

### Build

```bash
cd agent
cargo build
```

### Test

```bash
cd agent
cargo test
```

### Clean

```bash
make clean
```

## Workflow Example

```bash
# 1. One-time setup
make setup
# → Add displayed env vars to .env

# 2. Submit jobs
make add  # Submit first job
make add  # Submit second job
make add  # Submit third job

# 3. Process jobs (in another terminal)
make run
# → Agent processes all pending jobs

# 4. Submit more jobs
make add
# → Agent picks up new jobs automatically (if still running)
```

## Notes

- **JWT Expiry**:
  - Setup command creates 1-year JWT (long-lived for app instance)
  - Add command creates 24-hour JWT (for job submission)
- **Job Processing**: Mock delays (10s) simulate real work
- **Graceful Shutdown**: Press Ctrl+C to stop agent gracefully
- **Direct Mode**: Private layer uses Direct operation mode (jobs start immediately, not batched)

## Troubleshooting

### "SILVANA_PRIVATE_KEY not set"
Run `make setup` first to generate keys.

### "Failed to connect to State Service"
Ensure the Private coordination layer is running at `STATE_SERVICE_URL`.

### "No job available - exiting"
No pending jobs for this developer/agent/method combination. Submit jobs with `make add`.

### Docker build fails
Ensure you have Docker installed and protobuf compiler available.

## See Also

- Ethereum example: `examples/add-ethereum/`
- Sui coordination: `crates/coordination-sui/`
- Private coordination: `crates/coordination-private/`
- State proto definitions: `proto/silvana/state/v1/state.proto`
