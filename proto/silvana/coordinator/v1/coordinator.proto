syntax = "proto3";

import "google/protobuf/descriptor.proto";

package silvana.coordinator.v1;

option go_package = "github.com/SilvanaOne/zk-tests/packages/avs/rpc/proto;coordinator";


// Job message matching the partial Move struct
message Job {
  uint64 job_sequence = 1;
  optional string description = 2;
  // Metadata of the agent method to call
  string developer = 3;
  string agent =4 ;
  string agent_method = 5;
  // Metadata of the calling app instance
  string app = 6;
  string app_instance = 7;
  string app_instance_method = 8;
  repeated uint64 sequences = 9;
  bytes data = 10;
  // Generated unique job ID for agent reference
  string job_id = 11;
  // Metadata of the job
  uint32 attempts = 12;
  // Metadata of the job
  uint64 created_at = 13;
  uint64 updated_at = 14;
}

// Request message for getting a job
message GetJobRequest {
  string developer = 1;
  string agent = 2;
  string agent_method = 3;
  string session_id = 4;
}

// Response message containing a job
message GetJobResponse {
  optional Job job = 1;
}

// Request message for completing a job
message CompleteJobRequest {
  string job_id = 1;
  string session_id = 2;
}

// Response message for job completion
message CompleteJobResponse {
  bool success = 1;
  string message = 2;
}

// Request message for failing a job
message FailJobRequest {
  string job_id = 1;
  string error_message = 2;
  string session_id = 3;
}

// Response message for job failure
message FailJobResponse {
  bool success = 1;
  string message = 2;
}

// Request message for submitting a proof
message SubmitProofRequest {
  string session_id = 1;
  uint64 block_number = 2;
  repeated uint64 sequences = 3; // should be sorted
  repeated uint64 merged_sequences_1 = 4; // optional
  repeated uint64 merged_sequences_2 = 5; // optional
  string job_id = 6;
  string proof = 7;
  uint64 cpu_time = 8; // in milliseconds
}

// Response message for proof submission
message SubmitProofResponse {
  string tx_hash = 1;
  string da_hash = 2;
}

// Sequence state message matching the Move SequenceState struct
message SequenceState {
  uint64 sequence = 1;
  optional bytes state = 2;
  optional string data_availability = 3;
  bytes optimistic_state = 4;
  bytes transition_data = 5;
}

// Request message for querying sequence states
message GetSequenceStatesRequest {
  string session_id = 1;
  string job_id = 2;
  uint64 sequence = 3;
}

// Response message for sequence states query
message GetSequenceStatesResponse {
  repeated SequenceState states = 1;
}

// Request message for reading data availability by hash
message ReadDataAvailabilityRequest {
  string da_hash = 1;
  string session_id = 2;
}

// Response message for data availability read
message ReadDataAvailabilityResponse {
  optional string data = 1;
  bool success = 2;
  string message = 3;
}

// gRPC service definition
service CoordinatorService {
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
  rpc CompleteJob(CompleteJobRequest) returns (CompleteJobResponse);
  rpc FailJob(FailJobRequest) returns (FailJobResponse);
  rpc SubmitProof(SubmitProofRequest) returns (SubmitProofResponse);
  rpc GetSequenceStates(GetSequenceStatesRequest) returns (GetSequenceStatesResponse);
  rpc ReadDataAvailability(ReadDataAvailabilityRequest) returns (ReadDataAvailabilityResponse);
}